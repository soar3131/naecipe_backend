openapi: 3.0.3
info:
  title: Naecipe - SavedRecipe API
  description: 레시피 저장 (원본 레시피 → 레시피북) API
  version: 1.0.0

servers:
  - url: /api/v1
    description: API v1

tags:
  - name: saved-recipes
    description: 저장된 레시피 관리

paths:
  /cookbooks/{cookbook_id}/recipes:
    post:
      tags:
        - saved-recipes
      summary: 레시피 저장
      description: 원본 레시피를 레시피북에 저장합니다.
      operationId: saveRecipe
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/CookbookId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SaveRecipeRequest'
      responses:
        '201':
          description: 저장 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SavedRecipeResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '422':
          $ref: '#/components/responses/ValidationError'

    get:
      tags:
        - saved-recipes
      summary: 저장된 레시피 목록 조회
      description: 레시피북에 저장된 레시피 목록을 조회합니다.
      operationId: listSavedRecipes
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/CookbookId'
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Offset'
      responses:
        '200':
          description: 조회 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SavedRecipeListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /cookbooks/{cookbook_id}/recipes/{saved_recipe_id}:
    get:
      tags:
        - saved-recipes
      summary: 저장된 레시피 상세 조회
      description: 저장된 레시피의 상세 정보를 조회합니다.
      operationId: getSavedRecipe
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/CookbookId'
        - $ref: '#/components/parameters/SavedRecipeId'
      responses:
        '200':
          description: 조회 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SavedRecipeDetailResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      tags:
        - saved-recipes
      summary: 저장된 레시피 수정
      description: 저장된 레시피의 메모를 수정합니다.
      operationId: updateSavedRecipe
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/CookbookId'
        - $ref: '#/components/parameters/SavedRecipeId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateSavedRecipeRequest'
      responses:
        '200':
          description: 수정 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SavedRecipeResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          $ref: '#/components/responses/ValidationError'

    delete:
      tags:
        - saved-recipes
      summary: 저장된 레시피 삭제
      description: 저장된 레시피를 삭제합니다. 연결된 보정 레시피도 함께 삭제됩니다.
      operationId: deleteSavedRecipe
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/CookbookId'
        - $ref: '#/components/parameters/SavedRecipeId'
      responses:
        '204':
          description: 삭제 성공
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    CookbookId:
      name: cookbook_id
      in: path
      required: true
      description: 레시피북 ID
      schema:
        type: string
        format: uuid

    SavedRecipeId:
      name: saved_recipe_id
      in: path
      required: true
      description: 저장된 레시피 ID
      schema:
        type: string
        format: uuid

    Limit:
      name: limit
      in: query
      required: false
      description: 페이지당 항목 수
      schema:
        type: integer
        default: 20
        minimum: 1
        maximum: 100

    Offset:
      name: offset
      in: query
      required: false
      description: 건너뛸 항목 수
      schema:
        type: integer
        default: 0
        minimum: 0

  schemas:
    SaveRecipeRequest:
      type: object
      required:
        - recipe_id
      properties:
        recipe_id:
          type: string
          format: uuid
          description: 저장할 원본 레시피 ID
        memo:
          type: string
          maxLength: 1000
          nullable: true
          description: 개인 메모

    UpdateSavedRecipeRequest:
      type: object
      properties:
        memo:
          type: string
          maxLength: 1000
          nullable: true
          description: 개인 메모

    RecipeSummary:
      type: object
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
        thumbnail_url:
          type: string
          nullable: true
        chef_name:
          type: string
          nullable: true

    RecipeDetail:
      type: object
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
        description:
          type: string
          nullable: true
        thumbnail_url:
          type: string
          nullable: true
        video_url:
          type: string
          nullable: true
        chef_name:
          type: string
          nullable: true
        prep_time_minutes:
          type: integer
          nullable: true
        cook_time_minutes:
          type: integer
          nullable: true
        servings:
          type: integer
          nullable: true
        difficulty:
          type: string
          nullable: true
        ingredients:
          type: array
          items:
            $ref: '#/components/schemas/Ingredient'
        steps:
          type: array
          items:
            $ref: '#/components/schemas/CookingStep'
        tags:
          type: array
          items:
            type: string

    Ingredient:
      type: object
      properties:
        name:
          type: string
        amount:
          type: string
          nullable: true
        unit:
          type: string
          nullable: true
        note:
          type: string
          nullable: true

    CookingStep:
      type: object
      properties:
        step_number:
          type: integer
        description:
          type: string
        image_url:
          type: string
          nullable: true
        tip:
          type: string
          nullable: true

    SavedRecipeResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        cookbook_id:
          type: string
          format: uuid
        recipe:
          $ref: '#/components/schemas/RecipeSummary'
        memo:
          type: string
          nullable: true
        cook_count:
          type: integer
        personal_rating:
          type: number
          format: decimal
          nullable: true
        last_cooked_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    SavedRecipeDetailResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        cookbook_id:
          type: string
          format: uuid
        recipe:
          $ref: '#/components/schemas/RecipeDetail'
        memo:
          type: string
          nullable: true
        cook_count:
          type: integer
        personal_rating:
          type: number
          format: decimal
          nullable: true
        last_cooked_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    SavedRecipeListResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/SavedRecipeResponse'
        total:
          type: integer
          description: 전체 항목 수
        limit:
          type: integer
        offset:
          type: integer

    ErrorResponse:
      type: object
      properties:
        detail:
          type: string
          description: 에러 메시지
        code:
          type: string
          description: 에러 코드

  responses:
    Unauthorized:
      description: 인증 필요
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            detail: "Not authenticated"
            code: "UNAUTHORIZED"

    NotFound:
      description: 리소스 없음
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            detail: "Resource not found"
            code: "NOT_FOUND"

    Conflict:
      description: 중복 리소스
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            detail: "Recipe already saved to this cookbook"
            code: "RECIPE_ALREADY_SAVED"

    ValidationError:
      description: 유효성 검사 실패
      content:
        application/json:
          schema:
            type: object
            properties:
              detail:
                type: array
                items:
                  type: object
                  properties:
                    loc:
                      type: array
                      items:
                        type: string
                    msg:
                      type: string
                    type:
                      type: string
